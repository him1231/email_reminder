const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["assets/index.esm-BY31_S74.js","assets/index-C5_2xh_7.js","assets/index-CUVkCZ0s.css"])))=>i.map(i=>d[i]);
import{r as x,_ as T,b as w,j as e,B as d,S as C,c as y,e as R,n as A,h as B,s as z,q as N,o as $,i as U,C as D,k as q,T as g,l as F,d as P}from"./index-C5_2xh_7.js";import{d as G}from"./Add-DGN82Ua4.js";import{d as W}from"./Delete-DgQqBsFG.js";import{F as O,a as H,c as M,d as V,e as L,b as J}from"./index.esm-mGC2TZ_3.js";import{G as u}from"./Grid-BqnhMXwo.js";import{T as b,I as K}from"./TextField-C8S6uSne.js";import{I as Q}from"./IconButton-Dg2dHsNK.js";import"./index.esm-BY31_S74.js";import"./Grow-DlmGeTXG.js";import"./resolveComponentProps-B3ec8Sda.js";const X=M().shape({groupIds:J(),name:L().required("Name is required"),staffNo:L().required("Staff number is required"),email:L().email("Invalid email").required("Email is required"),contractEffectiveDate:V().required("Contract effective date is required")}),Y=({onClose:h})=>{const[E,j]=x.useState([]);x.useEffect(()=>{(async()=>{const{collection:r,getDocs:s,orderBy:n,query:i}=await T(async()=>{const{collection:a,getDocs:f,orderBy:c,query:o}=await import("./index.esm-BY31_S74.js").then(l=>l.i);return{collection:a,getDocs:f,orderBy:c,query:o}},__vite__mapDeps([0,1,2])),t=i(r(w,"staff_groups"),n("order","asc")),m=await s(t);j(m.docs.map(a=>({id:a.id,...a.data()})))})()},[]);const k=x.useMemo(()=>{const r=new Map;E.forEach(i=>r.set(i.id,{...i,children:[]}));const s=[];r.forEach(i=>{const t=i.parentId||null;t&&r.has(t)?r.get(t).children.push(i):s.push(i)});const n=i=>i.sort((t,m)=>(t.order||0)-(m.order||0)).forEach(t=>t.children&&n(t.children));return n(s),s},[E]),I=(r,s,n,i=!0)=>r.map(t=>{var c;const m=i,a=!!((c=s.groupIds)!=null&&c.includes(t.id)),f=!m;return e.jsxs(d,{sx:{pl:2},children:[e.jsxs("label",{children:[e.jsx("input",{type:"checkbox",checked:a,disabled:(t.parentId,f),onChange:o=>{if(o.target.checked)n("groupIds",Array.from(new Set([...s.groupIds||[],t.id])));else{const l=[],v=p=>{var S;l.push(p.id),(S=p.children)==null||S.forEach(_=>v(_))};v(t),n("groupIds",(s.groupIds||[]).filter(p=>!l.includes(p)))}}})," ",t.name]}),t.children&&t.children.length>0&&(s.groupIds||[]).includes(t.id)&&I(t.children,s,n,!0)]},t.id)});return e.jsx(O,{initialValues:{name:"",staffNo:"",email:"",contractEffectiveDate:"",groupIds:[]},validationSchema:X,onSubmit:async(r,{setSubmitting:s})=>{try{if(!R.currentUser)throw new Error("not-authenticated");await A(B(w,"staff"),{name:r.name,staffNo:r.staffNo,email:r.email,contractEffectiveDate:new Date(r.contractEffectiveDate),groupIds:r.groupIds||[],createdAt:z(),createdBy:R.currentUser.uid}),h==null||h()}finally{s(!1)}},children:({isSubmitting:r,touched:s,errors:n,handleChange:i,values:t,setFieldValue:m})=>e.jsx(H,{children:e.jsxs(u,{container:!0,spacing:2,children:[e.jsx(u,{item:!0,xs:12,sm:6,children:e.jsx(b,{name:"name",label:"Full name",value:t.name,onChange:i,error:!!(s.name&&n.name),helperText:s.name&&n.name,fullWidth:!0,size:"small"})}),e.jsx(u,{item:!0,xs:12,sm:6,children:e.jsx(b,{name:"staffNo",label:"Staff no.",value:t.staffNo,onChange:i,fullWidth:!0,size:"small"})}),e.jsx(u,{item:!0,xs:12,sm:6,children:e.jsx(b,{name:"email",label:"Email",value:t.email,onChange:i,fullWidth:!0,size:"small"})}),e.jsx(u,{item:!0,xs:12,sm:6,children:e.jsx(b,{name:"contractEffectiveDate",label:"Contract effective date",type:"date",value:t.contractEffectiveDate,onChange:i,InputLabelProps:{shrink:!0},fullWidth:!0,size:"small"})}),e.jsx(u,{item:!0,xs:12,children:e.jsxs(d,{children:[e.jsx(K,{id:"groups-label",children:"Groups"}),e.jsx(d,{sx:{border:"1px solid #eee",borderRadius:1,p:1,maxHeight:300,overflow:"auto"},children:I(k,{groupIds:t.groupIds},m)})]})}),e.jsx(u,{item:!0,xs:12,children:e.jsxs(C,{direction:"row",spacing:2,justifyContent:"flex-end",children:[e.jsx(y,{variant:"text",onClick:()=>h==null?void 0:h(),children:"Cancel"}),e.jsx(y,{type:"submit",disabled:r,variant:"contained",children:"Save"})]})})]})})})},le=()=>{const[h,E]=x.useState([]),[j,k]=x.useState(""),[I,r]=x.useState(!1),[s,n]=x.useState(!0),[i,t]=x.useState(null);x.useEffect(()=>{if(new URLSearchParams(window.location.search).get("forceLoading")==="1")return n(!0),()=>{};const f=N(B(w,"staff"),$("createdAt","desc")),c=U(f,o=>{E(o.docs.map(l=>({id:l.id,...l.data()}))),n(!1)},o=>{console.error("staff list snapshot error",o),t((o==null?void 0:o.message)||"Unable to load staff"),n(!1)});return()=>c()},[]);const m=h.filter(a=>{var f,c;return((f=a.name)==null?void 0:f.toLowerCase().includes(j.toLowerCase()))||((c=a.email)==null?void 0:c.toLowerCase().includes(j.toLowerCase()))});return e.jsxs(d,{children:[e.jsxs(C,{direction:{xs:"column",md:"row"},justifyContent:"space-between",alignItems:"center",mb:2,spacing:2,children:[e.jsx(b,{label:"Search staff",size:"small",value:j,onChange:a=>k(a.target.value),sx:{width:320}}),e.jsx(C,{direction:"row",spacing:1,children:e.jsx(y,{startIcon:e.jsx(G,{}),variant:"contained",onClick:()=>r(!0),children:"Add staff"})})]}),I&&e.jsx(D,{sx:{mb:2},children:e.jsx(q,{children:e.jsx(Y,{onClose:()=>r(!1)})})}),e.jsxs(u,{container:!0,spacing:2,children:[s&&!h.length?e.jsx(u,{item:!0,xs:12,"data-testid":"staff-list-loading",children:e.jsx(D,{children:e.jsxs(q,{children:[e.jsx(g,{variant:"body2",color:"text.secondary",children:"Loading staff…"}),e.jsx(d,{sx:{mt:1,display:"grid",gap:1},children:[1,2,3].map(a=>e.jsxs(d,{"data-testid":`staff-placeholder-${a}`,sx:{display:"flex",alignItems:"center",gap:2,p:1,bgcolor:"background.paper",borderRadius:1},children:[e.jsx(d,{sx:{width:40,height:40,borderRadius:"50%",bgcolor:"action.hover"}}),e.jsxs(d,{sx:{flex:1},children:[e.jsx(d,{sx:{width:"40%",height:12,bgcolor:"action.hover",borderRadius:1,mb:.5}}),e.jsx(d,{sx:{width:"60%",height:10,bgcolor:"action.hover",borderRadius:1}})]})]},a))})]})})}):m.map(a=>{var f,c;return e.jsx(u,{item:!0,xs:12,sm:6,md:4,children:e.jsx(D,{children:e.jsx(q,{children:e.jsxs(C,{direction:"row",justifyContent:"space-between",alignItems:"start",children:[e.jsxs(d,{children:[e.jsx(g,{variant:"subtitle1",children:a.name}),e.jsxs(g,{variant:"body2",color:"text.secondary",children:[a.staffNo," • ",a.email]}),e.jsxs(g,{variant:"caption",color:"text.secondary",children:["Contract: ",(f=a.contractEffectiveDate)!=null&&f.toDate?a.contractEffectiveDate.toDate().toISOString().slice(0,10):a.contractEffectiveDate]})]}),e.jsxs(d,{children:[e.jsx(y,{size:"small",onClick:async()=>{try{const o={to:a.email,subject:"Test Email from Email Reminder",body:`Hello ${a.name},

This is a test email added to the queue from the Email Reminder demo.`,status:"pending",createdAt:new Date,scheduledFor:new Date,sentAt:null,error:null},{addDoc:l,collection:v}=await T(async()=>{const{addDoc:p,collection:S}=await import("./index.esm-BY31_S74.js").then(_=>_.i);return{addDoc:p,collection:S}},__vite__mapDeps([0,1,2]));await l(v(w,"email_queue"),o),alert("Email added to queue.")}catch(o){console.error("add to queue failed",o),alert("Unable to add email to queue: "+o.message)}},children:"Add to queue"}),e.jsx(y,{size:"small",onClick:()=>window.location.hash=`#/staff/${a.id}/edit`,children:"Edit"}),((c=R.currentUser)==null?void 0:c.uid)===a.createdBy&&e.jsx(Q,{"aria-label":"delete-staff",size:"small",onClick:async()=>{if(window.confirm(`Delete staff “${a.name}”? This cannot be undone.`))try{await F(P(w,"staff",a.id))}catch(l){console.error("delete staff failed",l),alert("Unable to delete staff: "+l.message)}},children:e.jsx(W,{fontSize:"small"})})]})]})})})},a.id)}),!m.length&&!s&&e.jsx(u,{item:!0,xs:12,children:e.jsx(D,{children:e.jsx(q,{children:e.jsx(g,{variant:"body2",color:"text.secondary",children:'No staff found. Use the "Add staff" button to create a new record.'})})})})]})]})};export{le as StaffList};
