import{v as Y,x as ee,r as s,y as Xe,z as te,A as C,j as e,D as ae,F as re,G as q,m as Ze,M as Qe,a3 as ot,E as V,J as nt,K as it,X as lt,U as ct,u as dt,a as ut,i as mt,h as Ue,g as ft,d as X,B as ze,S as $e,T as b,C as qe,k as We,c as G,b as U,e as Pe,n as ht,s as Oe,f as Le}from"./index-CbYJMVzh.js";import{G as n}from"./Grid-Ci02xzul.js";import{f as gt,T as z,F as B,I as E,S as N,a as Ve}from"./TextField-BgZTWqKq.js";import{S as xt}from"./Switch-A0YHhoKr.js";import{M as c,C as Z}from"./MenuItem-Cnk0G5Od.js";import{u as pt}from"./Grow-DtVAx6xa.js";import{F as $}from"./FormControlLabel-BQKSWLAp.js";import{S as jt}from"./SwitchBase-C69rQmeF.js";import{D as vt,a as Ct,b as St,c as bt}from"./DialogTitle-DtfCdj8f.js";import"./index.esm-DxwDVbjq.js";import"./resolveComponentProps-CivoGKXj.js";function Rt(a){return Y("MuiFormGroup",a)}ee("MuiFormGroup",["root","row","error"]);const Tt=["className","row"],yt=a=>{const{classes:r,row:o,error:i}=a;return re({root:["root",o&&"row",i&&"error"]},Rt,r)},kt=q("div",{name:"MuiFormGroup",slot:"Root",overridesResolver:(a,r)=>{const{ownerState:o}=a;return[r.root,o.row&&r.row]}})(({ownerState:a})=>C({display:"flex",flexDirection:"column",flexWrap:"wrap"},a.row&&{flexDirection:"row"})),Ft=s.forwardRef(function(r,o){const i=Xe({props:r,name:"MuiFormGroup"}),{className:d,row:x=!1}=i,R=te(i,Tt),T=pt(),p=gt({props:i,muiFormControl:T,states:["error"]}),j=C({},i,{row:x,error:p.error}),y=yt(j);return e.jsx(kt,C({className:ae(y.root,d),ownerState:j,ref:o},R))}),wt=Ze(e.jsx("path",{d:"M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm0 18c-4.42 0-8-3.58-8-8s3.58-8 8-8 8 3.58 8 8-3.58 8-8 8z"}),"RadioButtonUnchecked"),Bt=Ze(e.jsx("path",{d:"M8.465 8.465C9.37 7.56 10.62 7 12 7C14.76 7 17 9.24 17 12C17 13.38 16.44 14.63 15.535 15.535C14.63 16.44 13.38 17 12 17C9.24 17 7 14.76 7 12C7 10.62 7.56 9.37 8.465 8.465Z"}),"RadioButtonChecked"),It=q("span",{name:"MuiRadioButtonIcon",shouldForwardProp:Qe})({position:"relative",display:"flex"}),Et=q(wt,{name:"MuiRadioButtonIcon"})({transform:"scale(1)"}),Nt=q(Bt,{name:"MuiRadioButtonIcon"})(({theme:a,ownerState:r})=>C({left:0,position:"absolute",transform:"scale(0)",transition:a.transitions.create("transform",{easing:a.transitions.easing.easeIn,duration:a.transitions.duration.shortest})},r.checked&&{transform:"scale(1)",transition:a.transitions.create("transform",{easing:a.transitions.easing.easeOut,duration:a.transitions.duration.shortest})}));function Ye(a){const{checked:r=!1,classes:o={},fontSize:i}=a,d=C({},a,{checked:r});return e.jsxs(It,{className:o.root,ownerState:d,children:[e.jsx(Et,{fontSize:i,className:o.background,ownerState:d}),e.jsx(Nt,{fontSize:i,className:o.dot,ownerState:d})]})}const et=s.createContext(void 0);function At(){return s.useContext(et)}function Mt(a){return Y("MuiRadio",a)}const _e=ee("MuiRadio",["root","checked","disabled","colorPrimary","colorSecondary","sizeSmall"]),Dt=["checked","checkedIcon","color","icon","name","onChange","size","className"],Gt=a=>{const{classes:r,color:o,size:i}=a,d={root:["root",`color${V(o)}`,i!=="medium"&&`size${V(i)}`]};return C({},r,re(d,Mt,r))},Ut=q(jt,{shouldForwardProp:a=>Qe(a)||a==="classes",name:"MuiRadio",slot:"Root",overridesResolver:(a,r)=>{const{ownerState:o}=a;return[r.root,o.size!=="medium"&&r[`size${V(o.size)}`],r[`color${V(o.color)}`]]}})(({theme:a,ownerState:r})=>C({color:(a.vars||a).palette.text.secondary},!r.disableRipple&&{"&:hover":{backgroundColor:a.vars?`rgba(${r.color==="default"?a.vars.palette.action.activeChannel:a.vars.palette[r.color].mainChannel} / ${a.vars.palette.action.hoverOpacity})`:nt(r.color==="default"?a.palette.action.active:a.palette[r.color].main,a.palette.action.hoverOpacity),"@media (hover: none)":{backgroundColor:"transparent"}}},r.color!=="default"&&{[`&.${_e.checked}`]:{color:(a.vars||a).palette[r.color].main}},{[`&.${_e.disabled}`]:{color:(a.vars||a).palette.action.disabled}}));function zt(a,r){return typeof r=="object"&&r!==null?a===r:String(a)===String(r)}const He=e.jsx(Ye,{checked:!0}),Je=e.jsx(Ye,{}),Ke=s.forwardRef(function(r,o){var i,d;const x=Xe({props:r,name:"MuiRadio"}),{checked:R,checkedIcon:T=He,color:p="primary",icon:j=Je,name:y,onChange:k,size:F="medium",className:m}=x,I=te(x,Dt),v=C({},x,{color:p,size:F}),w=Gt(v),g=At();let u=R;const M=ot(k,g&&g.onChange);let A=y;return g&&(typeof u>"u"&&(u=zt(g.value,x.value)),typeof A>"u"&&(A=g.name)),e.jsx(Ut,C({type:"radio",icon:s.cloneElement(j,{fontSize:(i=Je.props.fontSize)!=null?i:F}),checkedIcon:s.cloneElement(T,{fontSize:(d=He.props.fontSize)!=null?d:F}),ownerState:v,classes:w,name:A,checked:u,onChange:M,ref:o,className:ae(w.root,m)},I))});function $t(a){return Y("MuiRadioGroup",a)}ee("MuiRadioGroup",["root","row","error"]);const qt=["actions","children","className","defaultValue","name","onChange","value"],Wt=a=>{const{classes:r,row:o,error:i}=a;return re({root:["root",o&&"row",i&&"error"]},$t,r)},Pt=s.forwardRef(function(r,o){const{actions:i,children:d,className:x,defaultValue:R,name:T,onChange:p,value:j}=r,y=te(r,qt),k=s.useRef(null),F=Wt(r),[m,I]=it({controlled:j,default:R,name:"RadioGroup"});s.useImperativeHandle(i,()=>({focus:()=>{let u=k.current.querySelector("input:not(:disabled):checked");u||(u=k.current.querySelector("input:not(:disabled)")),u&&u.focus()}}),[]);const v=lt(o,k),w=ct(T),g=s.useMemo(()=>({name:w,onChange(u){I(u.target.value),p&&p(u,u.target.value)},value:m}),[w,p,I,m]);return e.jsx(et.Provider,{value:g,children:e.jsx(Ft,C({role:"radiogroup",ref:v,className:ae(F.root,x)},y,{children:d}))})}),Q={staff:{fields:["name","email","contractEffectiveDate","contractEndDate","status","department","createdAt","updatedAt"],dateFields:["contractEffectiveDate","contractEndDate","createdAt","updatedAt"],triggerableFields:["contractEffectiveDate","contractEndDate","status","department"]}},ea=()=>{var ve,Ce,Se,be,Re,Te;const{id:a}=dt(),r=a==="new"||!a,o=ut(),[i,d]=s.useState([]),[x,R]=s.useState(!0),[T,p]=s.useState(!1),[j,y]=s.useState(""),[k,F]=s.useState(!0),[m,I]=s.useState("staff"),[v,w]=s.useState("created"),[g,u]=s.useState(""),[M,A]=s.useState(!1),[se,oe]=s.useState(""),[ne,ie]=s.useState("=="),[le,ce]=s.useState(""),[_,de]=s.useState(""),[H,J]=s.useState("email"),[D,ue]=s.useState(!1),[W,me]=s.useState(!1),[P,fe]=s.useState(""),[O,he]=s.useState(3),[ge,xe]=s.useState("days"),[K,pe]=s.useState("createdAt"),[f,je]=s.useState(null),[tt,L]=s.useState(!1);s.useEffect(()=>{const t=mt(Ue(U,"templates"),S=>{d(S.docs.map(h=>({id:h.id,...h.data()})))});return r?R(!1):(async()=>{var h,ye,ke,Fe,we,Be,Ie,Ee,Ne,Ae,Me,De,Ge;const S=await ft(X(U,"rules",a));if(S.exists()){const l=S.data();y(l.name||""),F(l.enabled!==!1),I(((h=l.trigger)==null?void 0:h.collection)||"staff"),w(((ye=l.trigger)==null?void 0:ye.event)||"created"),u(((ke=l.trigger)==null?void 0:ke.field)||""),l.condition&&(A(!0),oe(l.condition.field||""),ie(l.condition.operator||"=="),ce(String(l.condition.value||""))),de(((Fe=l.emailConfig)==null?void 0:Fe.templateId)||""),J(((we=l.emailConfig)==null?void 0:we.recipientField)||"email"),ue(!!((Be=l.emailConfig)!=null&&Be.useTriggeredStaff)),me(!!((Ie=l.emailConfig)!=null&&Ie.bcc)),fe(typeof((Ee=l.emailConfig)==null?void 0:Ee.bcc)=="string"?l.emailConfig.bcc:""),he(((Ae=(Ne=l.emailConfig)==null?void 0:Ne.relativeTime)==null?void 0:Ae.value)||3),xe(((De=(Me=l.emailConfig)==null?void 0:Me.relativeTime)==null?void 0:De.unit)||"days"),pe(((Ge=l.emailConfig)==null?void 0:Ge.baseTimeField)||"createdAt"),je({lastTriggeredAt:l.lastTriggeredAt||null,lastTriggeredStaff:l.lastTriggeredStaff||[],lastError:l.lastError})}R(!1)})(),()=>{t()}},[a]);const at=()=>j.trim()?m?v?_?!D&&!H.trim()?"Recipient field is required":!O||Number(O)<=0?"Relative time must be > 0":K.trim()?W&&P.trim()&&P.split(",").map(h=>h.trim()).filter(Boolean).some(h=>!/^[^@\s]+@[^@\s]+\.[^@\s]+$/.test(h))?"One or more BCC addresses look invalid":null:"Base time field is required":"Template is required":"Event is required":"Collection is required":"Name is required",rt=async()=>{const t=at();if(t)return alert(t);if(!Pe.currentUser)return alert("Not authenticated");p(!0);const S={name:j.trim(),enabled:k,trigger:{collection:m,event:v,...v==="updated"&&g?{field:g}:{}},emailConfig:{templateId:_,recipientField:H||"email",useTriggeredStaff:D,bcc:W?P:void 0,relativeTime:{value:Number(O),unit:ge},baseTimeField:K}};M&&(S.condition={field:se,operator:ne,value:le});try{r?await ht(Ue(U,"rules"),{...S,lastTriggeredAt:Oe(),lastTriggeredStaff:[],createdAt:Oe(),createdBy:Pe.currentUser.uid}):await Le(X(U,"rules",a),S),o("/rules")}catch(h){console.error(h),alert("Save failed: "+h.message)}p(!1)},st=async()=>{if(a){L(!1);try{await Le(X(U,"rules",a),{lastTriggeredAt:null,lastTriggeredStaff:[]}),je({lastTriggeredAt:null,lastTriggeredStaff:[]}),alert("Tracking reset")}catch(t){console.error(t),alert("Reset failed: "+t.message)}}};return x?e.jsx("div",{children:"Loading…"}):e.jsxs(ze,{children:[e.jsx($e,{direction:"row",justifyContent:"space-between",alignItems:"center",mb:2,children:e.jsx(b,{variant:"h5",children:r?"Create Rule":"Edit Rule"})}),e.jsx(qe,{children:e.jsx(We,{children:e.jsxs(n,{container:!0,spacing:2,children:[e.jsx(n,{item:!0,xs:12,md:6,children:e.jsx(z,{label:"Rule Name",value:j,onChange:t=>y(t.target.value),fullWidth:!0,required:!0})}),e.jsx(n,{item:!0,xs:12,md:6,children:e.jsxs($e,{direction:"row",alignItems:"center",spacing:1,children:[e.jsx(b,{children:"Enabled"}),e.jsx(xt,{checked:k,onChange:t=>F(t.target.checked)})]})}),e.jsx(n,{item:!0,xs:12,children:e.jsx(b,{variant:"subtitle1",children:"Trigger"})}),e.jsx(n,{item:!0,xs:12,md:4,children:e.jsxs(B,{fullWidth:!0,children:[e.jsx(E,{children:"Collection"}),e.jsx(N,{value:m,label:"Collection",onChange:t=>I(String(t.target.value)),children:e.jsx(c,{value:"staff",children:"staff"})})]})}),e.jsx(n,{item:!0,xs:12,md:4,children:e.jsx(B,{children:e.jsxs(Pt,{row:!0,value:v,onChange:t=>w(t.target.value),children:[e.jsx($,{value:"created",control:e.jsx(Ke,{}),label:"Created"}),e.jsx($,{value:"updated",control:e.jsx(Ke,{}),label:"Updated"})]})})}),v==="updated"&&e.jsx(n,{item:!0,xs:12,md:4,children:e.jsxs(B,{fullWidth:!0,margin:"normal",children:[e.jsx(E,{children:"Field to Monitor (optional)"}),e.jsxs(N,{value:g,onChange:t=>u(String(t.target.value)),label:"Field to Monitor (optional)",children:[e.jsx(c,{value:"",children:e.jsx("em",{children:"Any field change"})}),(Ce=(ve=Q[m])==null?void 0:ve.triggerableFields)==null?void 0:Ce.map(t=>e.jsx(c,{value:t,children:t},t))]}),e.jsx(Ve,{children:"Leave empty to trigger on any update, or select a specific field"})]})}),e.jsx(n,{item:!0,xs:12,children:e.jsx(b,{variant:"subtitle1",children:"Condition (optional)"})}),e.jsx(n,{item:!0,xs:12,children:e.jsx($,{control:e.jsx(Z,{checked:M,onChange:t=>A(t.target.checked)}),label:"Add condition"})}),M&&e.jsxs(e.Fragment,{children:[e.jsx(n,{item:!0,xs:12,md:4,children:e.jsxs(B,{fullWidth:!0,children:[e.jsx(E,{children:"Condition Field"}),e.jsx(N,{value:se,onChange:t=>oe(String(t.target.value)),children:(be=(Se=Q[m])==null?void 0:Se.fields)==null?void 0:be.map(t=>e.jsx(c,{value:t,children:t},t))})]})}),e.jsx(n,{item:!0,xs:12,md:4,children:e.jsxs(B,{fullWidth:!0,children:[e.jsx(E,{children:"Operator"}),e.jsxs(N,{value:ne,onChange:t=>ie(String(t.target.value)),children:[e.jsx(c,{value:"==",children:"equals (==)"}),e.jsx(c,{value:"!=",children:"not equals (!=)"}),e.jsx(c,{value:">",children:"greater than (>)"}),e.jsx(c,{value:"<",children:"less than (<)"}),e.jsx(c,{value:">=",children:"greater or equal (>=)"}),e.jsx(c,{value:"<=",children:"less or equal (<=)"})]})]})}),e.jsx(n,{item:!0,xs:12,md:4,children:e.jsx(z,{label:"Value",value:le,onChange:t=>ce(t.target.value),fullWidth:!0})})]}),e.jsx(n,{item:!0,xs:12,children:e.jsx(b,{variant:"subtitle1",children:"Email Configuration"})}),e.jsx(n,{item:!0,xs:12,md:6,children:e.jsxs(B,{fullWidth:!0,children:[e.jsx(E,{children:"Template"}),e.jsxs(N,{value:_,label:"Template",onChange:t=>de(String(t.target.value)),children:[e.jsx(c,{value:"",children:"Select template"}),i.map(t=>e.jsx(c,{value:t.id,children:t.subject||t.name||t.id},t.id))]})]})}),m==="staff"&&e.jsx(n,{item:!0,xs:12,md:6,children:e.jsx($,{control:e.jsx(Z,{checked:D,onChange:t=>{ue(t.target.checked),t.target.checked&&J("email")}}),label:"Send to triggered staff member"})}),e.jsx(n,{item:!0,xs:12,md:6,children:e.jsx(z,{label:"Recipient Field",value:H,onChange:t=>J(t.target.value),placeholder:"email",fullWidth:!0,required:!0,disabled:D,helperText:D?"Will use the email of the staff member who triggered this rule":"Field containing recipient email address"})}),e.jsxs(n,{item:!0,xs:12,md:6,children:[e.jsx($,{control:e.jsx(Z,{checked:W,onChange:t=>me(t.target.checked)}),label:"Add BCC recipients (optional)"}),W&&e.jsx(z,{fullWidth:!0,margin:"normal",label:"BCC Recipients",value:P,onChange:t=>fe(t.target.value),placeholder:"email1@example.com, email2@example.com",helperText:"Comma-separated email addresses for BCC"})]}),e.jsx(n,{item:!0,xs:12,md:4,children:e.jsx(z,{type:"number",label:"Send After",value:O,onChange:t=>he(t.target.value===""?"":Number(t.target.value)),fullWidth:!0})}),e.jsx(n,{item:!0,xs:12,md:4,children:e.jsxs(B,{fullWidth:!0,children:[e.jsx(E,{children:"Unit"}),e.jsxs(N,{value:ge,label:"Unit",onChange:t=>xe(t.target.value),children:[e.jsx(c,{value:"days",children:"days"}),e.jsx(c,{value:"weeks",children:"weeks"}),e.jsx(c,{value:"months",children:"months"}),e.jsx(c,{value:"years",children:"years"})]})]})}),e.jsx(n,{item:!0,xs:12,md:4,children:e.jsxs(B,{fullWidth:!0,children:[e.jsx(E,{children:"Base Time Field"}),e.jsx(N,{value:K,onChange:t=>pe(String(t.target.value)),children:(Te=(Re=Q[m])==null?void 0:Re.dateFields)==null?void 0:Te.map(t=>e.jsx(c,{value:t,children:t},t))}),e.jsx(Ve,{children:"Date field to calculate send time from"})]})}),!r&&e.jsx(n,{item:!0,xs:12,children:e.jsx(qe,{variant:"outlined",children:e.jsxs(We,{children:[e.jsx(b,{variant:"subtitle2",children:"Tracking Info"}),e.jsxs(b,{children:["Last triggered: ",f!=null&&f.lastTriggeredAt?String(f.lastTriggeredAt):"Never"]}),e.jsxs(b,{children:["Triggered staff count: ",Array.isArray(f==null?void 0:f.lastTriggeredStaff)?f.lastTriggeredStaff.length:0]}),(f==null?void 0:f.lastError)&&e.jsxs(b,{color:"error",children:["Last error: ",f.lastError]})]})})}),e.jsx(n,{item:!0,xs:12,children:e.jsxs(ze,{sx:{display:"flex",gap:1,justifyContent:"flex-end"},children:[!r&&e.jsx(G,{color:"warning",variant:"outlined",onClick:()=>L(!0),children:"Reset Tracking"}),e.jsx(G,{onClick:()=>o("/rules"),children:"Cancel"}),e.jsx(G,{variant:"contained",onClick:rt,disabled:T,children:T?"Saving…":"Save"})]})})]})})}),e.jsxs(vt,{open:tt,onClose:()=>L(!1),children:[e.jsx(Ct,{children:"Reset tracking"}),e.jsx(St,{children:"This will reset tracking data. The rule will process documents again. Continue?"}),e.jsxs(bt,{children:[e.jsx(G,{onClick:()=>L(!1),children:"Cancel"}),e.jsx(G,{color:"warning",variant:"contained",onClick:st,children:"Reset"})]})]})]})};export{ea as RuleEditor,ea as default};
