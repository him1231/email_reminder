const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["assets/index.esm-BY31_S74.js","assets/index-C5_2xh_7.js","assets/index-CUVkCZ0s.css"])))=>i.map(i=>d[i]);
import{u as z,a as B,r as g,g as W,d as w,_ as A,b as j,j as e,B as E,S as G,c as q,e as L,f as P,s as R}from"./index-C5_2xh_7.js";import{F as T,a as $,c as O,b as H,d as M,e as I}from"./index.esm-mGC2TZ_3.js";import{G as o}from"./Grid-BqnhMXwo.js";import{T as h,F as U,I as V}from"./TextField-C8S6uSne.js";import"./index.esm-BY31_S74.js";import"./Grow-DlmGeTXG.js";import"./resolveComponentProps-B3ec8Sda.js";const J=O().shape({name:I().required("Name is required"),staffNo:I().required("Staff number is required"),email:I().email("Invalid email").required("Email is required"),contractEffectiveDate:M().required("Contract effective date is required"),groupIds:H()}),ae=()=>{const{id:f}=z(),u=B(),[b,N]=g.useState(null),[_,C]=g.useState([]);return g.useEffect(()=>{f&&((async()=>{var c;const a=await W(w(j,"staff",f));if(!a.exists()){alert("Staff not found"),u("/staff");return}const r=a.data();N({name:r.name||"",staffNo:r.staffNo||"",email:r.email||"",contractEffectiveDate:(c=r.contractEffectiveDate)!=null&&c.toDate?r.contractEffectiveDate.toDate().toISOString().slice(0,10):r.contractEffectiveDate,groupIds:r.groupIds||[]})})(),(async()=>{const{collection:a,getDocs:r,orderBy:c,query:x}=await A(async()=>{const{collection:n,getDocs:m,orderBy:i,query:t}=await import("./index.esm-BY31_S74.js").then(s=>s.i);return{collection:n,getDocs:m,orderBy:i,query:t}},__vite__mapDeps([0,1,2])),d=x(a(j,"staff_groups"),c("createdAt","desc")),l=await r(d);C(l.docs.map(n=>({id:n.id,...n.data()})))})())},[f,u]),b?e.jsx(E,{children:e.jsx(T,{initialValues:b,validationSchema:J,onSubmit:async(a,{setSubmitting:r})=>{try{if(!L.currentUser)throw new Error("not-authenticated");await P(w(j,"staff",f),{name:a.name,staffNo:a.staffNo,email:a.email,contractEffectiveDate:new Date(a.contractEffectiveDate),groupIds:a.groupIds||[],updatedAt:R()}),u("/staff")}finally{r(!1)}},children:({values:a,handleChange:r,setFieldValue:c,isSubmitting:x})=>e.jsx($,{children:e.jsxs(o,{container:!0,spacing:2,children:[e.jsx(o,{item:!0,xs:12,sm:6,children:e.jsx(h,{name:"name",label:"Full name",value:a.name,onChange:r,fullWidth:!0,size:"small"})}),e.jsx(o,{item:!0,xs:12,sm:6,children:e.jsx(h,{name:"staffNo",label:"Staff no.",value:a.staffNo,onChange:r,fullWidth:!0,size:"small"})}),e.jsx(o,{item:!0,xs:12,sm:6,children:e.jsx(h,{name:"email",label:"Email",value:a.email,onChange:r,fullWidth:!0,size:"small"})}),e.jsx(o,{item:!0,xs:12,sm:6,children:e.jsx(h,{name:"contractEffectiveDate",label:"Contract effective date",type:"date",value:a.contractEffectiveDate,onChange:r,InputLabelProps:{shrink:!0},fullWidth:!0,size:"small"})}),e.jsx(o,{item:!0,xs:12,children:e.jsxs(U,{fullWidth:!0,size:"small",children:[e.jsx(V,{id:"groups-label",children:"Groups"}),e.jsx(E,{sx:{border:"1px solid #eee",borderRadius:1,p:1,maxHeight:300,overflow:"auto"},children:(()=>{const d=new Map;_.forEach(i=>d.set(i.id,{...i,children:[]}));const l=[];d.forEach(i=>{const t=i.parentId||null;t&&d.has(t)?d.get(t).children.push(i):l.push(i)});const n=i=>i.sort((t,s)=>(t.order||0)-(s.order||0)).forEach(t=>t.children&&n(t.children));n(l);const m=(i,t)=>i.map(s=>{var D;return e.jsxs(E,{sx:{pl:2},children:[e.jsxs("label",{children:[e.jsx("input",{type:"checkbox",checked:(D=t.groupIds)==null?void 0:D.includes(s.id),disabled:!!s.parentId&&!(t.groupIds||[]).includes(s.parentId),onChange:k=>{if(k.target.checked)c("groupIds",Array.from(new Set([...t.groupIds||[],s.id])));else{const S=[],y=p=>{var v;S.push(p.id),(v=p.children)==null||v.forEach(F=>y(F))};y(s),c("groupIds",(t.groupIds||[]).filter(p=>!S.includes(p)))}}})," ",s.name]}),s.children&&s.children.length>0&&(t.groupIds||[]).includes(s.id)&&m(s.children,t)]},s.id)});return m(l,a)})()})]})}),e.jsx(o,{item:!0,xs:12,children:e.jsxs(G,{direction:"row",spacing:2,justifyContent:"flex-end",children:[e.jsx(q,{variant:"text",onClick:()=>u("/staff"),children:"Cancel"}),e.jsx(q,{type:"submit",disabled:x,variant:"contained",children:"Save"})]})})]})})})}):e.jsx("div",{children:"Loadingâ€¦"})};export{ae as StaffEdit};
