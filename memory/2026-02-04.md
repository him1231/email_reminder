# 2026-02-04 - Email Reminder Project Session

## Project Overview
User: him1231 (tszhimmak@gmail.com)
Project: email_reminder - Email scheduling system with GitHub Pages CMS + Firestore + GitHub Actions

## Major Accomplishments

### 1. Email Sending System (Server-side)
- **Removed client-side SmtpJS** (security issue - credentials exposed)
- **Implemented GitHub Actions scheduled sending:**
  - Workflow: `.github/workflows/send-emails.yml` (every 5 min)
  - Script: `scripts/send-pending-emails.js` (firebase-admin + nodemailer)
  - Uses repository secrets: FIREBASE_SERVICE_ACCOUNT, SMTP_USER, SMTP_PASS
  - Successfully tested: 2 emails sent to tszhimmak@hkbu.edu.hk
- **Email Queue system:**
  - Firestore `email_queue` collection
  - Status: pending â†’ sent/failed
  - UI: EmailQueue page shows pending + history

### 2. Firestore Configuration
- **Rules deployed** for email_queue collection
- **Indexes created** for queries:
  - status + createdAt
  - status + scheduledFor
- **Firebase project:** email-reminder-17e91
- **Service account:** configured for GitHub Actions

### 3. Compose Email Feature
- **New page:** ComposeEmail (`/compose`)
- **Features:**
  - Multi-select staff dropdown with search (StaffSelector component)
  - Template selector (existing templates) or write new
  - Mustache placeholder support ({{name}}, {{email}})
  - Save new templates (htmlBody, createdBy, serverTimestamp)
  - Schedule time picker (send now or future datetime)
  - Preview button (renders template with staff data)
  - Batch create email_queue entries
- **Fixes applied:**
  - Hide subject/body fields when template selected
  - Template save uses htmlBody + createdBy to match Firestore rules
  - Auth check before submit
  - Detailed error logging

### 4. Workflows Cleanup
- **Deleted unnecessary workflows:**
  - ci-build.yml (redundant with ci.yml)
  - scheduler-dryrun.yml (replaced by send-emails.yml)
  - ci.yml (no tests needed)
  - regenerate-lockfile.yml (rarely used)
- **Remaining workflows:**
  - deploy-pages.yml (GitHub Pages deployment)
  - send-emails.yml (scheduled email sending)

### 5. GitHub Actions Scheduled Workflow Issue
- **Problem:** Cron schedule not running automatically
- **Cause:** GitHub disables scheduled workflows on private repos/forks by default
- **Workaround:** Manual trigger via workflow_dispatch
- **Documentation added:** docs/EMAILS.md troubleshooting section

## Technical Decisions

### Sub-agents Used
- User requested all coding tasks be done via sub-agents
- Model used: github-copilot/gpt-5-mini
- Successfully completed multiple feature implementations

### Authentication
- Firebase CLI: logged in as tszhimmak@gmail.com
- GitHub CLI: logged in as him1231
- Service account key: generated and added to GitHub secrets (base64 encoded to handle newlines)

### Firestore Schema
**Templates:**
- Fields: name, subject, htmlBody, createdAt, createdBy
- Rules require exact field names (htmlBody not body)

**Staff:**
- Has email, name fields
- Used for recipient selection

**Email Queue:**
- to, subject, body, status, createdAt, scheduledFor, sentAt, error

## Next Steps (Rules Engine)

User wants to implement automated rule-based email scheduling:

### Requirements:
- Trigger on Firestore changes (staff created/updated)
- Relative time scheduling (e.g., "3 months after contractEffectiveDate")
- Template selection
- Condition matching (optional filters)

### Chosen Approach: Option B (GitHub Actions Polling)
- Workflow runs every 10 minutes
- Checks staff collection for changes
- Matches rules and schedules emails
- Tracks lastTriggeredAt + lastTriggeredStaff to avoid duplicates

### Rules Schema:
```
{
  name, enabled,
  trigger: { collection, event, field },
  condition: { field, operator, value },
  emailConfig: { templateId, recipientField, relativeTime, baseTimeField },
  lastTriggeredAt, lastTriggeredStaff
}
```

**Status:** Design approved, ready for implementation

## User Preferences
- Use Cantonese for communication
- Prefers sub-agents for all coding tasks
- Uses GitHub Copilot Pro
- Model preference: github-copilot/claude-sonnet-4.5 (main) / gpt-5-mini (sub-agents)
- **Auto-deploy Firestore rules:** Whenever firestore.rules changes, automatically deploy with `firebase deploy --only firestore:rules`

## Repository Details
- Repo: https://github.com/him1231/email_reminder.git
- Local: /home/ubuntu/.openclaw/workspace/repo
- Main branch: auto-deploys to GitHub Pages
- Firebase project ID: email-reminder-17e91

## Cron Jobs Discussion
- User has 2 active cron jobs (leave office reminder, Unit A countdown)
- Clarified: Cron sessions can be deleted safely (only history records)
- Cron jobs stored in gateway, not affected by session cleanup
